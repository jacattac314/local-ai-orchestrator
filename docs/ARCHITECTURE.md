# Architecture Documentation

## Overview

Local AI Orchestrator is an intelligent routing system that manages requests to multiple LLM providers (OpenRouter, LMSYS, HuggingFace) with dynamic optimization based on quality, latency, and cost metrics.

## System Architecture

```
┌─────────────────────────────────────────────────────┐
│                   Client Applications                │
│              (REST API, Python SDK, CLI)             │
└────────────────────┬────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────┐
│              FastAPI Application (api/)              │
│  ├─ routes.py      (HTTP endpoints)                 │
│  ├─ app.py         (FastAPI setup)                  │
│  └─ model_service.py (Model management)             │
└────────────┬────────────────────────────────────────┘
             │
      ┌──────┼──────────────────┐
      ▼      ▼                  ▼
┌──────────┐ ┌──────────────┐ ┌──────────────────┐
│ Routing  │ │ Resilience   │ │ Database Layer   │
│ System   │ │ & Security   │ │ (SQLAlchemy)     │
├──────────┤ ├──────────────┤ ├──────────────────┤
│- Router  │ │- URL Validator│ │- Model metadata  │
│- Scoring │ │- API Key Auth│ │- Metrics         │
│- Profiles│ │- Circuit     │ │- Custom models   │
│- Complex.│ │  Breaker     │ │- Cache data      │
└────┬─────┘ │- Offline     │ └──────────────────┘
     │       │  Cache       │
     │       └──────────────┘
     │
   ┌─┴──────────────────────────────────────┐
   ▼                                        ▼
┌──────────────────┐          ┌──────────────────────┐
│  Benchmark Data  │          │ HTTP Client          │
│   Integration    │          │ (with retry logic)   │
├──────────────────┤          └──────────────────────┘
│- OpenRouter API  │                     │
│- LMSYS Arena     │                     │
│- HuggingFace Hub │          ┌──────────┴──────────┐
│- Entity Resolver │          ▼                     ▼
└──────────────────┘    ┌────────────────┐  ┌────────────────┐
                        │ OpenRouter API │  │ External APIs  │
                        └────────────────┘  └────────────────┘
```

## Core Components

### 1. API Layer (`src/orchestrator/api/`)

**Purpose**: Handle HTTP requests and expose OpenAI-compatible endpoints

**Files**:
- `routes.py`: REST endpoints for chat completions, model listing, health checks
- - `app.py`: FastAPI application initialization and middleware
  - - `model_service.py`: Model-specific business logic
   
    - **Key Endpoints**:
    - - `POST /v1/chat/completions` - OpenAI-compatible chat endpoint
      - - `GET /v1/models` - List available models
        - - `GET /v1/models/rankings` - Get ranked models by profile
          - - `GET /health` - Health check endpoint
           
            - **Design Pattern**:
            - - Uses Pydantic models for request/response validation
              - - Implements async request handling for performance
                - - Supports OpenAI API-compatible interface for drop-in replacement
                 
                  - ### 2. Routing System (`src/orchestrator/routing/`)
                 
                  - **Purpose**: Intelligently select the best model for each request
                 
                  - **Components**:
                 
                  - #### Router (`router.py`)
                  - - Main orchestration logic
                    - - Selects model based on routing profile
                      - - Implements fallback mechanism
                        - - Handles circuit breaker logic
                         
                          - #### Scoring System (`scorer.py`)
                          - - Calculates model scores based on:
                            -   - Quality metrics (accuracy, helpfulness)
                                -   - Latency benchmarks
                                    -   - Cost per token
                                        - - Weights metrics according to routing profile
                                         
                                          - #### Complexity Classifier (`complexity.py`)
                                          - - Analyzes request complexity
                                            - - Adjusts model selection based on prompt difficulty
                                              - - Simple requests → cheaper models
                                                - - Complex requests → higher quality models
                                                 
                                                  - #### Routing Profiles (`profiles.py`)
                                                  - - **Quality**: Prioritizes accuracy and capability
                                                    - - **Balanced**: Mix of performance and cost (default)
                                                      - - **Speed**: Minimizes response latency
                                                        - - **Budget**: Optimizes for cost
                                                          - - **Long Context**: Supports 100k+ token windows
                                                           
                                                            - **Algorithm Flow**:
                                                            - ```
                                                              Request → Extract Prompt → Classify Complexity
                                                                       → Select Profile → Get Ranking
                                                                       → Filter Available → Apply Circuit Breaker
                                                                       → Score Models → Select Top Match
                                                                       → Execute Request → Log Metrics
                                                                       → Handle Failures → Fallback to Next Model
                                                              ```

                                                              ### 3. Data Layer (`src/orchestrator/db/`)

                                                              **Purpose**: Persist and manage model data, metrics, and configuration

                                                              **Components**:

                                                              #### Database Models
                                                              - `Model`: Metadata about each LLM (provider, context window, cost)
                                                              - - `Metric`: Request/response performance data
                                                                - - `RoutingDecision`: Logged routing choices for analytics
                                                                  - - `CustomModel`: User-defined model configurations
                                                                   
                                                                    - #### Database Manager
                                                                    - - Connection pooling
                                                                      - - Session management
                                                                        - - Query optimization
                                                                         
                                                                          - **Database Design**:
                                                                          - - SQLite default (development/local use)
                                                                            - - PostgreSQL support for production
                                                                              - - Automatic cleanup of old metrics (configurable retention)
                                                                               
                                                                                - ### 4. Adapter System (`src/orchestrator/adapters/`)
                                                                               
                                                                                - **Purpose**: Integrate with external benchmark and API sources
                                                                               
                                                                                - **Current Adapters**:
                                                                               
                                                                                - #### OpenRouter Adapter
                                                                                - - Fetches latest model list and pricing
                                                                                  - - Caches for performance
                                                                                    - - Syncs on configurable interval
                                                                                     
                                                                                      - #### LMSYS Arena Adapter
                                                                                      - - Ingests benchmark data from LMSYS leaderboard
                                                                                        - - Updates model quality metrics
                                                                                          - - Historical tracking of performance changes
                                                                                           
                                                                                            - #### HuggingFace Adapter
                                                                                            - - Accesses HF model Hub data
                                                                                              - - Gets context window and capability info
                                                                                                - - Community ratings integration
                                                                                                 
                                                                                                  - #### Entity Resolution
                                                                                                  - - Fuzzy matching across sources (same model, different names)
                                                                                                    - - Consolidates model information
                                                                                                      - - Resolves conflicts between sources
                                                                                                       
                                                                                                        - **Design Pattern**:
                                                                                                        - - Abstract base adapter interface
                                                                                                          - - Pluggable architecture for new sources
                                                                                                            - - Scheduled syncing via APScheduler
                                                                                                             
                                                                                                              - ### 5. Resilience & Security (`src/orchestrator/security.py`, `resilience.py`)
                                                                                                             
                                                                                                              - **Security**:
                                                                                                              - - URL validation (SSRF protection)
                                                                                                                - - API key authentication
                                                                                                                  - - Environment-based configuration
                                                                                                                    - - Request validation with Pydantic
                                                                                                                     
                                                                                                                      - **Resilience**:
                                                                                                                      - - **Circuit Breaker**: Disables failing models temporarily
                                                                                                                        - - **Offline Cache**: Falls back to cached responses if all APIs down
                                                                                                                          - - **Retry Logic**: Configurable retries with exponential backoff
                                                                                                                            - - **Timeout Handling**: Prevents hung requests
                                                                                                                              - - **Data Pruning**: Removes old metrics automatically
                                                                                                                               
                                                                                                                                - ### 6. Scheduler (`src/orchestrator/scheduler/`)
                                                                                                                               
                                                                                                                                - **Purpose**: Background jobs for data synchronization
                                                                                                                               
                                                                                                                                - **Tasks**:
                                                                                                                                - - Sync OpenRouter models (configurable interval)
                                                                                                                                  - - Sync LMSYS benchmarks
                                                                                                                                    - - Sync HuggingFace models
                                                                                                                                      - - Prune old metrics
                                                                                                                                        - - Health checks
                                                                                                                                         
                                                                                                                                          - **Implementation**: APScheduler for reliable task scheduling
                                                                                                                                         
                                                                                                                                          - ### 7. Analytics (`src/orchestrator/analytics/`)
                                                                                                                                         
                                                                                                                                          - **Purpose**: Track and analyze routing decisions
                                                                                                                                         
                                                                                                                                          - **Metrics Tracked**:
                                                                                                                                          - - Model selection per request
                                                                                                                                            - - Response latency
                                                                                                                                              - - Cost per request
                                                                                                                                                - - Fallback usage
                                                                                                                                                  - - Error rates
                                                                                                                                                    - - Cache hit rates
                                                                                                                                                     
                                                                                                                                                      - ## Data Flow
                                                                                                                                                     
                                                                                                                                                      - ### Request Flow
                                                                                                                                                     
                                                                                                                                                      - 1. **Request Ingestion** (API Layer)
                                                                                                                                                        2.    - Receive OpenAI-compatible request
                                                                                                                                                              -    - Validate with Pydantic models
                                                                                                                                                                   -    - Extract routing profile (query param or header)
                                                                                                                                                                    
                                                                                                                                                                        - 2. **Complexity Analysis** (Routing System)
                                                                                                                                                                          3.    - Tokenize and analyze prompt
                                                                                                                                                                                -    - Classify complexity level
                                                                                                                                                                                     -    - Store for metrics
                                                                                                                                                                                      
                                                                                                                                                                                          - 3. **Model Selection** (Router)
                                                                                                                                                                                            4.    - Get applicable models for profile
                                                                                                                                                                                                  -    - Apply circuit breaker filters
                                                                                                                                                                                                       -    - Score remaining models
                                                                                                                                                                                                            -    - Select top-ranked model
                                                                                                                                                                                                             
                                                                                                                                                                                                                 - 4. **Request Execution** (HTTP Client)
                                                                                                                                                                                                                   5.    - Forward to selected provider
                                                                                                                                                                                                                         -    - Implement retry logic
                                                                                                                                                                                                                              -    - Handle timeouts
                                                                                                                                                                                                                               
                                                                                                                                                                                                                                   - 5. **Response & Logging** (API Layer)
                                                                                                                                                                                                                                     6.    - Return response to client
                                                                                                                                                                                                                                           -    - Log routing decision
                                                                                                                                                                                                                                                -    - Update metrics
                                                                                                                                                                                                                                                     -    - Trigger async cleanup
                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                          - 6. **Fallback** (if model fails)
                                                                                                                                                                                                                                                            7.    - Mark model in circuit breaker
                                                                                                                                                                                                                                                                  -    - Retry with next-ranked model
                                                                                                                                                                                                                                                                       -    - Update metrics
                                                                                                                                                                                                                                                                            -    - Return response or error
                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                 - ### Data Sync Flow
                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                 - 1. **Scheduled Sync** (APScheduler)
                                                                                                                                                                                                                                                                                   2.    - Trigger adapter sync tasks
                                                                                                                                                                                                                                                                                         -    - Call external APIs
                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                              - 2. **Data Integration** (Adapters)
                                                                                                                                                                                                                                                                                                3.    - Fetch latest data
                                                                                                                                                                                                                                                                                                      -    - Transform to standard format
                                                                                                                                                                                                                                                                                                           -    - Handle entity resolution
                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                - 3. **Database Update** (Database Manager)
                                                                                                                                                                                                                                                                                                                  4.    - Upsert model records
                                                                                                                                                                                                                                                                                                                        -    - Update metrics
                                                                                                                                                                                                                                                                                                                             -    - Clear old cache entries
                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                  - 4. **Scoring Recalculation** (Router)
                                                                                                                                                                                                                                                                                                                                    5.    - Rebuild model rankings
                                                                                                                                                                                                                                                                                                                                          -    - Update profile scores
                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                               - ## Configuration System
                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                               - **Pydantic Settings** (`config.py`):
                                                                                                                                                                                                                                                                                                                                               - - Loads from `.env` file
                                                                                                                                                                                                                                                                                                                                                 - - Type-safe configuration
                                                                                                                                                                                                                                                                                                                                                   - - Validation on startup
                                                                                                                                                                                                                                                                                                                                                     - - Sensible defaults
                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                       - **Key Configuration Groups**:
                                                                                                                                                                                                                                                                                                                                                       - - Database: Connection string, pool settings
                                                                                                                                                                                                                                                                                                                                                         - - Adapters: API keys, sync intervals
                                                                                                                                                                                                                                                                                                                                                           - - Scheduler: Task schedules, timeouts
                                                                                                                                                                                                                                                                                                                                                             - - Security: SSRF allowlist, API key requirements
                                                                                                                                                                                                                                                                                                                                                               - - Performance: Cache sizes, retry counts
                                                                                                                                                                                                                                                                                                                                                                 - - Logging: Log levels, formats
                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                   - ## Performance Considerations
                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                   - ### Optimization Strategies
                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                   - 1. **Caching**
                                                                                                                                                                                                                                                                                                                                                                     2.    - Cache adapter responses (configurable TTL)
                                                                                                                                                                                                                                                                                                                                                                           -    - Cache model rankings per profile
                                                                                                                                                                                                                                                                                                                                                                                -    - Offline cache fallback
                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                     - 2. **Database**
                                                                                                                                                                                                                                                                                                                                                                                       3.    - Connection pooling
                                                                                                                                                                                                                                                                                                                                                                                             -    - Index on frequently queried columns
                                                                                                                                                                                                                                                                                                                                                                                                  -    - Automatic metric cleanup
                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                       - 3. **Scoring**
                                                                                                                                                                                                                                                                                                                                                                                                         4.    - Pre-calculated rankings cached
                                                                                                                                                                                                                                                                                                                                                                                                               -    - Quick circuit breaker checks
                                                                                                                                                                                                                                                                                                                                                                                                                    -    - Lazy-load adapter data
                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                         - 4. **Request Handling**
                                                                                                                                                                                                                                                                                                                                                                                                                           5.    - Async/await for concurrent requests
                                                                                                                                                                                                                                                                                                                                                                                                                                 -    - Non-blocking background tasks
                                                                                                                                                                                                                                                                                                                                                                                                                                      -    - Stream responses when possible
                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                           - ### Load Testing Results
                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                           - Typical performance characteristics:
                                                                                                                                                                                                                                                                                                                                                                                                                                           - - Model selection: <100ms per request
                                                                                                                                                                                                                                                                                                                                                                                                                                             - - Overhead vs direct API: <10%
                                                                                                                                                                                                                                                                                                                                                                                                                                               - - Throughput: 1000+ requests/sec (local SQLite)
                                                                                                                                                                                                                                                                                                                                                                                                                                                 - - Scaling: Linear with database optimization
                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                   - ## Scalability
                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                   - ### Single Node
                                                                                                                                                                                                                                                                                                                                                                                                                                                   - - Suitable for <10k requests/day
                                                                                                                                                                                                                                                                                                                                                                                                                                                     - - SQLite database
                                                                                                                                                                                                                                                                                                                                                                                                                                                       - - Local caching sufficient
                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                         - ### Multi-Node (Production)
                                                                                                                                                                                                                                                                                                                                                                                                                                                         - - PostgreSQL backend
                                                                                                                                                                                                                                                                                                                                                                                                                                                           - - Redis for distributed caching
                                                                                                                                                                                                                                                                                                                                                                                                                                                             - - Shared scheduler coordination (via database)
                                                                                                                                                                                                                                                                                                                                                                                                                                                               - - Load balancer in front
                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                 - ### Database Scaling
                                                                                                                                                                                                                                                                                                                                                                                                                                                                 - - Indexes on `model_name`, `created_at`, `routing_profile`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                   - - Partition metrics by time
                                                                                                                                                                                                                                                                                                                                                                                                                                                                     - - Archive old data
                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       - ## Dependencies
                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       - **Core**:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       - - `fastapi`: Web framework
                                                                                                                                                                                                                                                                                                                                                                                                                                                                         - - `sqlalchemy`: ORM
                                                                                                                                                                                                                                                                                                                                                                                                                                                                           - - `pydantic`: Data validation
                                                                                                                                                                                                                                                                                                                                                                                                                                                                             - - `httpx`: Async HTTP client
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                               - **Data Integration**:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                               - - `apscheduler`: Task scheduling
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 - - `requests`: HTTP client for adapters
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   - - `fuzzywuzzy`: Entity resolution
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     - **CLI/SDK**:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     - - `typer`: CLI framework
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       - - `click`: CLI utilities
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         - **Development**:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         - - `pytest`: Testing
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           - - `ruff`, `black`: Code quality
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             - - `mypy`: Type checking
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               - ## Future Architecture Enhancements
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               - 1. **caching Layer**: Redis/Memcached for distributed caching
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 2. 2. **Event System**: Event-driven architecture for updates
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    3. 3. **Plugin System**: Allow user-defined adapters and routers
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       4. 4. **Monitoring**: OpenTelemetry instrumentation
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          5. 5. **GraphQL API**: Alternative query interface
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             6. 6. **Real-time Streaming**: WebSocket support
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                7. 7. **Load Balancing**: Built-in request distribution
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   8. ## References
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   9. - See [CONTRIBUTING.md](../CONTRIBUTING.md) for development workflow
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      - - See [README.md](../README.md) for quick start
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        - - See [DEPLOYMENT.md](DEPLOYMENT.md) for production setup
