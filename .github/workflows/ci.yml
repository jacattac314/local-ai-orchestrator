name: CI

on:
  push:
      branches: [ master, main ]
        pull_request:
            branches: [ master, main ]

            jobs:
              test:
                  runs-on: ubuntu-latest
                      strategy:
                            matrix:
                                    python-version: ['3.9', '3.10', '3.11']

                                        steps:
                                            - uses: actions/checkout@v3

                                                - name: Set up Python ${{ matrix.python-version }}
                                                      uses: actions/setup-python@v4
                                                            with:
                                                                    python-version: ${{ matrix.python-version }}

                                                                        - name: Cache pip packages
                                                                              uses: actions/cache@v3
                                                                                    with:
                                                                                            path: ~/.cache/pip
                                                                                                    key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
                                                                                                            restore-keys: |
                                                                                                                      ${{ runner.os }}-pip-
                                                                                                                      
                                                                                                                          - name: Install Poetry
                                                                                                                                uses: snok/install-poetry@v1
                                                                                                                                      with:
                                                                                                                                              version: latest
                                                                                                                                                      virtualenvs-create: true
                                                                                                                                                              virtualenvs-in-project: true
                                                                                                                                                              
                                                                                                                                                                  - name: Install dependencies
                                                                                                                                                                        run: poetry install
                                                                                                                                                                        
                                                                                                                                                                            - name: Lint with ruff
                                                                                                                                                                                  run: poetry run ruff check src/ tests/
                                                                                                                                                                                  
                                                                                                                                                                                      - name: Format check with black
                                                                                                                                                                                            run: poetry run black --check src/ tests/
                                                                                                                                                                                            
                                                                                                                                                                                                - name: Type check with mypy
                                                                                                                                                                                                      run: poetry run mypy src/
                                                                                                                                                                                                      
                                                                                                                                                                                                          - name: Run tests
                                                                                                                                                                                                                run: poetry run pytest -v
                                                                                                                                                                                                                
                                                                                                                                                                                                                    - name: Run canary tests
                                                                                                                                                                                                                          run: poetry run pytest -m canary -v
                                                                                                                                                                                                                          
                                                                                                                                                                                                                              - name: Generate coverage report
                                                                                                                                                                                                                                    run: poetry run pytest --cov=src --cov-report=xml
                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                        - name: Upload coverage to Codecov
                                                                                                                                                                                                                                              uses: codecov/codecov-action@v3
                                                                                                                                                                                                                                                    with:
                                                                                                                                                                                                                                                            files: ./coverage.xml
                                                                                                                                                                                                                                                                    fail_ci_if_error: false
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                      lint:
                                                                                                                                                                                                                                                                          runs-on: ubuntu-latest
                                                                                                                                                                                                                                                                              steps:
                                                                                                                                                                                                                                                                                  - uses: actions/checkout@v3
                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                      - name: Set up Python
                                                                                                                                                                                                                                                                                            uses: actions/setup-python@v4
                                                                                                                                                                                                                                                                                                  with:
                                                                                                                                                                                                                                                                                                          python-version: '3.11'
                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                              - name: Install Poetry
                                                                                                                                                                                                                                                                                                                    uses: snok/install-poetry@v1
                                                                                                                                                                                                                                                                                                                          with:
                                                                                                                                                                                                                                                                                                                                  version: latest
                                                                                                                                                                                                                                                                                                                                          virtualenvs-create: true
                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                              - name: Install dependencies
                                                                                                                                                                                                                                                                                                                                                    run: poetry install
                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                        - name: Pre-commit hooks
                                                                                                                                                                                                                                                                                                                                                              run: poetry run pre-commit run --all-files
                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                security:
                                                                                                                                                                                                                                                                                                                                                                    runs-on: ubuntu-latest
                                                                                                                                                                                                                                                                                                                                                                        steps:
                                                                                                                                                                                                                                                                                                                                                                            - uses: actions/checkout@v3
                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                - name: Set up Python
                                                                                                                                                                                                                                                                                                                                                                                      uses: actions/setup-python@v4
                                                                                                                                                                                                                                                                                                                                                                                            with:
                                                                                                                                                                                                                                                                                                                                                                                                    python-version: '3.11'
                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                        - name: Install Poetry
                                                                                                                                                                                                                                                                                                                                                                                                              uses: snok/install-poetry@v1
                                                                                                                                                                                                                                                                                                                                                                                                                    with:
                                                                                                                                                                                                                                                                                                                                                                                                                            version: latest
                                                                                                                                                                                                                                                                                                                                                                                                                                    virtualenvs-create: true
                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                        - name: Install dependencies
                                                                                                                                                                                                                                                                                                                                                                                                                                              run: poetry install
                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                  - name: Run bandit security check
                                                                                                                                                                                                                                                                                                                                                                                                                                                        run: poetry run bandit -r src/ -f json -o bandit-report.json || true
                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                            - name: Upload security reports
                                                                                                                                                                                                                                                                                                                                                                                                                                                                  uses: actions/upload-artifact@v3
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if: always()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              with:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      name: security-reports
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              path: bandit-report.json
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                docker:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    runs-on: ubuntu-latest
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        steps:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            - uses: actions/checkout@v3
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - name: Set up Docker Buildx
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      uses: docker/setup-buildx-action@v2
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          - name: Build Docker image
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                uses: docker/build-push-action@v4
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      with:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              context: .
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      push: false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              tags: orchestrator:test
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      cache-from: type=gha
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              cache-to: type=gha,mode=max
